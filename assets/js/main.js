(()=>{"use strict";function e(e,t){if(["link","go"].includes(e))if(t){const e=document.querySelector(t);e?e.scrollIntoView({behavior:"smooth",block:"start"}):window.scrollTo({top:0})}else window.scrollTo({top:0})}function t(e){const t=new URL(e||window.location.href).href;return t.endsWith("/")||t.includes(".")||t.includes("#")?t:`${t}/`}function o(e){document.body.querySelectorAll("[flamethrower-preserve]").forEach((t=>{let o=e.body.querySelector('[flamethrower-preserve][id="'+t.id+'"]');if(o){const e=t.cloneNode(!0);o.replaceWith(e)}})),document.body.replaceWith(e.body)}function r(){document.head.querySelectorAll("[data-reload]").forEach(n),document.body.querySelectorAll("script").forEach(n)}function n(e){const t=document.createElement("script"),o=Array.from(e.attributes);for(const{name:e,value:r}of o)t[e]=r;t.append(e.textContent),e.replaceWith(t)}const s={log:!1,pageTransitions:!1};class i{constructor(e){this.opts=e,this.enabled=!0,this.prefetched=new Set,this.opts={...s,...null!=e?e:{}},null!=window&&window.history?(document.addEventListener("click",(e=>this.onClick(e))),window.addEventListener("popstate",(e=>this.onPop(e))),this.prefetch()):(console.warn("flamethrower router not supported in this browser or environment"),this.enabled=!1)}go(e){const t=window.location.href,o=new URL(e,location.origin).href;return this.reconstructDOM({type:"go",next:o,prev:t})}back(){window.history.back()}forward(){window.history.forward()}get allLinks(){return Array.from(document.links).filter((e=>e.href.includes(document.location.origin)&&!e.href.includes("#")&&e.href!==(document.location.href||document.location.href+"/")&&!this.prefetched.has(e.href)))}log(...e){this.opts.log&&console.log(...e)}prefetch(){if("visible"===this.opts.prefetch)this.prefetchVisible();else{if("hover"!==this.opts.prefetch)return;this.prefetchOnHover()}}prefetchOnHover(){this.allLinks.forEach((e=>{const t=e.getAttribute("href");e.addEventListener("pointerenter",(()=>this.createLink(t)),{once:!0})}))}prefetchVisible(){"IntersectionObserver"in window&&(this.observer||(this.observer=new IntersectionObserver(((e,t)=>{e.forEach((e=>{const o=e.target.getAttribute("href");this.prefetched.has(o)?t.unobserve(e.target):e.isIntersecting&&(this.createLink(o),t.unobserve(e.target))}))}),{root:null,rootMargin:"0px",threshold:1})),this.allLinks.forEach((e=>this.observer.observe(e))))}createLink(e){const t=document.createElement("link");t.rel="prefetch",t.href=e,t.as="document",t.onload=()=>this.log("ðŸŒ©ï¸ prefetched",e),t.onerror=t=>this.log("ðŸ¤• can't prefetch",e,t),document.head.appendChild(t),this.prefetched.add(e)}onClick(e){this.reconstructDOM(function(e){var o;let r;if(e.altKey||e.ctrlKey||e.metaKey||e.shiftKey)return{type:"disqualified"};for(let t=e.target;t.parentNode;t=t.parentNode)if("A"===t.nodeName){r=t;break}if(r&&r.host!==location.host)return r.target="_blank",{type:"external"};if(r&&"cold"in(null==r?void 0:r.dataset))return{type:"disqualified"};if(null!=r&&r.hasAttribute("href")){const n=r.getAttribute("href"),s=new URL(n,location.href);if(e.preventDefault(),null!=n&&n.startsWith("#"))return function(e){document.querySelector(e).scrollIntoView({behavior:"smooth",block:"start"})}(n),{type:"scrolled"};const i=null==(o=n.match(/#([\w'-]+)\b/g))?void 0:o[0];return{type:"link",next:t(s.href),prev:t(),scrollId:i}}return{type:"noop"}}(e))}onPop(e){this.reconstructDOM({type:"popstate",next:t()})}async reconstructDOM({type:t,next:n,prev:s,scrollId:i}){var c;if(this.enabled)try{if(this.log("âš¡",t),["popstate","link","go"].includes(t)&&n!==s){this.opts.log&&console.time("â±ï¸"),window.dispatchEvent(new CustomEvent("flamethrower:router:fetch")),"popstate"!=t&&(c=n,(!window.history.state||window.history.state.url!==c)&&window.history.pushState({url:c},"internalLink",c));const s=function(e){return(new DOMParser).parseFromString(e,"text/html")}(await(await fetch(n,{headers:{"X-Flamethrower":"1"}}).then((e=>{const t=e.body.getReader(),o=parseInt(e.headers.get("Content-Length"));let r=0;return new ReadableStream({start(e){!function n(){t.read().then((({done:t,value:s})=>{t?e.close():(r+=s.length,window.dispatchEvent(new CustomEvent("flamethrower:router:fetch-progress",{detail:{progress:Number.isNaN(o)?0:r/o*100,received:r,length:o||0}})),e.enqueue(s),n())}))}()}})})).then((e=>new Response(e,{headers:{"Content-Type":"text/html"}})))).text());(function(e){const t=e=>Array.from(e.querySelectorAll('head>:not([rel="prefetch"]')),o=t(document),r=t(e),{staleNodes:n,freshNodes:s}=function(e,t){const o=[],r=[];let n=0,s=0;for(;n<e.length||s<t.length;){const i=e[n],c=t[s];if(null!=i&&i.isEqualNode(c)){n++,s++;continue}const l=i?r.findIndex((e=>e.isEqualNode(i))):-1;if(-1!==l){r.splice(l,1),n++;continue}const a=c?o.findIndex((e=>e.isEqualNode(c))):-1;-1===a?(i&&o.push(i),c&&r.push(c),n++,s++):(o.splice(a,1),s++)}return{staleNodes:o,freshNodes:r}}(o,r);n.forEach((e=>e.remove())),document.head.append(...s)})(s),this.opts.pageTransitions&&document.createDocumentTransition?document.createDocumentTransition().start((()=>{o(s),r(),e(t,i)})):(o(s),r(),e(t,i)),window.dispatchEvent(new CustomEvent("flamethrower:router:end")),setTimeout((()=>{this.prefetch()}),200),this.opts.log&&console.timeEnd("â±ï¸")}}catch(e){return window.dispatchEvent(new CustomEvent("flamethrower:router:error",e)),this.opts.log&&console.timeEnd("â±ï¸"),console.error("ðŸ’¥ router fetch failed",e),!1}else this.log("router disabled")}}(e=>{const t=new i(e);console.log("ðŸ”¥ flamethrower engaged"),window&&(window.flamethrower=t)})()})();